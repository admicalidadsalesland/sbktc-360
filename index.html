<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìä Dashboard Semanal - Evaluaciones</title>

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f0f4ff, #e6edff);
      margin: 0;
      padding: 30px 20px;
      color: #1e293b;
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #0f172a;
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: -0.5px;
    }

    .search-box {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 35px;
      flex-wrap: wrap;
    }

    .search-box input {
      padding: 13px 16px;
      border: 1px solid #cbd5e1;
      border-radius: 12px;
      font-size: 16px;
      width: 300px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      outline: none;
      transition: all 0.25s ease;
    }

    .search-box input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
    }

    .search-box button {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 13px 28px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(59,130,246,0.3);
    }

    .search-box button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(59,130,246,0.4);
    }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 28px;
      padding: 10px;
    }

    .card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      padding: 24px;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }

    .metric-name {
      font-weight: 700;
      margin-bottom: 14px;
      font-size: 1.2rem;
      color: #1e3a8a;
    }

    .average {
      margin-top: 14px;
      font-weight: 700;
      font-size: 1.1rem;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    canvas {
      max-width: 100%;
      height: 220px !important;
      margin-top: 10px;
    }

    .info, .error {
      text-align: center;
      margin: 30px auto;
      padding: 20px;
      max-width: 600px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .error {
      color: #dc2626;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .cards-container {
        grid-template-columns: 1fr;
      }
      h1 {
        font-size: 1.5rem;
      }
      .search-box input {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <h1>üìà Evoluci√≥n Semanal por Indicador</h1>

  <div class="search-box">
    <input type="text" id="dniInput" placeholder="Buscar por DNI (ej: 40753375)" />
    <button onclick="searchByDNI()">Buscar Agente</button>
  </div>

  <div id="cardsContainer" class="cards-container">
    <div class="info">Cargando datos desde Google Sheets...</div>
  </div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRp7iRBUwVpHnmf7Q0mLyARIBl-inFlZbH43i3wU1whcjE0GlPi7Z51VcmXRsWrcYCmWMS1WTL-ySJt/pub?gid=2119161122&single=true&output=csv';

    // Colores distintivos por m√©trica
    const COLORS = {
      '1_COMUNICACI√ìN': { border: '#10b981', background: 'rgba(16,185,129,0.1)' },
      '2_INFORMACI√ìN': { border: '#f59e0b', background: 'rgba(245,158,11,0.1)' },
      '3_GESTION DE VENTA (PRE VENTA)': { border: '#8b5cf6', background: 'rgba(139,92,246,0.1)' },
      '4_REGULATORIO': { border: '#ef4444', background: 'rgba(239,68,68,0.1)' },
      'NOTA': { border: '#0ea5e9', background: 'rgba(14,165,233,0.1)' }
    };

    const COLUMNS = [
      { key: '1_COMUNICACI√ìN', label: 'Comunicaci√≥n' },
      { key: '2_INFORMACI√ìN', label: 'Informaci√≥n' },
      { key: '3_GESTION DE VENTA (PRE VENTA)', label: 'Gesti√≥n de Venta (Preventa)' },
      { key: '4_REGULATORIO', label: 'Regulatorio' },
      { key: 'NOTA', label: 'Nota General' }
    ];

    let allData = [];

    async function loadCSV() {
      try {
        const response = await fetch(CSV_URL);
        const text = await response.text();
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        allData = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',').map(v => v.trim().replace(/^"(.*)"$/, '$1'));
          if (values.length !== headers.length) continue;
          const row = {};
          headers.forEach((header, idx) => row[header] = values[idx]);
          
          COLUMNS.forEach(col => {
            let val = row[col.key];
            if (!val) { row[col.key] = null; return; }
            val = val.replace('%','').replace(',','.');
            let num = parseFloat(val);
            if (num <= 1) num *= 100; // escala 0-1 ‚Üí %
            if (num <= 5) num *= 20;   // escala 0-5 ‚Üí %
            row[col.key] = isNaN(num) ? null : Math.min(Math.max(num,0),130);
          });
          allData.push(row);
        }

        document.getElementById('cardsContainer').innerHTML =
          '<div class="info">‚úÖ Datos cargados. Ingresa un DNI para buscar el desempe√±o del agente.</div>';
      } catch (e) {
        document.getElementById('cardsContainer').innerHTML =
          `<div class="error">‚ùå Error al cargar los datos: ${e.message}</div>`;
      }
    }

    function searchByDNI() {
      const dni = document.getElementById('dniInput').value.trim();
      if (!dni) return alert("Por favor, ingresa un DNI");

      const filtered = allData.filter(r => r.DNI && r.DNI.includes(dni));
      if (filtered.length === 0) {
        document.getElementById('cardsContainer').innerHTML = 
          `<div class="error">No se encontr√≥ ning√∫n agente con DNI: <strong>${dni}</strong></div>`;
        return;
      }

      // Agrupar por semana
      const byWeek = {};
      filtered.forEach(row => {
        const week = row.SEMANA || "Semana X";
        if (!byWeek[week]) byWeek[week] = [];
        byWeek[week].push(row);
      });

      const weeks = Object.keys(byWeek).sort((a,b) => {
        const na = parseInt(a.match(/\d+/)?.[0] || 0);
        const nb = parseInt(b.match(/\d+/)?.[0] || 0);
        return na - nb;
      });

      // Calcular promedios por semana y m√©trica
      const averages = {};
      COLUMNS.forEach(col => {
        averages[col.key] = weeks.map(week => {
          const vals = byWeek[week].map(r => r[col.key]).filter(v => v !== null);
          return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
        });
      });

      // Calcular Total General (promedio de NOTA)
      const notaValues = averages['NOTA'].filter(v => v !== null);
      const totalGeneral = notaValues.length ? notaValues.reduce((a,b)=>a+b,0)/notaValues.length : 0;

      // Renderizar tarjetas
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';

      // Tarjetas de evoluci√≥n semanal
      COLUMNS.forEach(col => {
        const avgValues = averages[col.key];
        const validValues = avgValues.filter(v => v !== null);
        const globalAvg = validValues.length ? validValues.reduce((a,b)=>a+b,0)/validValues.length : 0;
        const color = COLORS[col.key] || { border: '#6b7280', background: 'rgba(107,114,128,0.1)' };

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="metric-name">${col.label}</div>
          <canvas id="chart-${col.key.replace(/\W/g,'')}"></canvas>
          <div class="average">${globalAvg.toFixed(1)}%</div>
        `;
        container.appendChild(card);

        const ctx = card.querySelector('canvas').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: weeks,
            datasets: [{
              label: col.label,
              data: avgValues,
              borderColor: color.border,
              backgroundColor: color.background,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: color.border,
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true, mode: 'index', intersect: false },
              datalabels: {
                display: context => context.dataset.data[context.dataIndex] !== null,
                formatter: (v) => v !== null ? v.toFixed(1) + '%' : '',
                color: '#1e293b',
                font: { weight: '600', size: 11 }
              }
            },
            scales: {
              y: {
                min: 0,
                max: 130,
                ticks: { 
                  stepSize: 20, 
                  color: '#64748b',
                  font: { size: 10 }
                },
                grid: { color: 'rgba(0,0,0,0.04)' }
              },
              x: {
                ticks: { 
                  color: '#475569',
                  font: { size: 11 },
                  maxRotation: 0,
                  autoSkip: false
                },
                grid: { color: 'rgba(0,0,0,0.03)' }
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            },
            animation: {
              duration: 1000,
              easing: 'easeOutQuart'
            }
          },
          plugins: [ChartDataLabels]
        });
      });

      // Tarjeta de Total General (anillo)
      const donutCard = document.createElement('div');
      donutCard.className = 'card';
      donutCard.innerHTML = `
        <div class="metric-name">Total General</div>
        <canvas id="donut-total"></canvas>
        <div class="average">${totalGeneral.toFixed(1)}%</div>
      `;
      container.appendChild(donutCard);

      const donutCtx = donutCard.querySelector('canvas').getContext('2d');
      new Chart(donutCtx, {
        type: 'doughnut',
        data: {
          labels: ['Cumplido', 'Faltante'],
          datasets: [{
            data: [totalGeneral, 100 - totalGeneral],
            backgroundColor: ['#10b981', '#e2e8f0'],
            borderWidth: 0,
            cutout: '70%'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false },
            datalabels: {
              display: true,
              formatter: () => `${totalGeneral.toFixed(1)}%`,
              color: '#0f172a',
              font: { size: 18, weight: 'bold' }
            }
          },
          animation: {
            animateRotate: true,
            duration: 1200
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    loadCSV();
  </script>
</body>
</html>
