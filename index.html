<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SBK360 | Notas</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary-red: #ef4444;
  --primary-dark: #b91c1c;
  --bg-gradient: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
  --card-bg: #ffffff;
  --text-main: #1e293b;
  --text-muted: #64748b;
  --shadow-soft: 0 4px 12px rgba(0,0,0,0.06);
  --shadow-menu: 0 8px 24px rgba(239,68,68,0.3);
  --menu-height: 70px;
}

/* RESET */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-gradient);
  color: var(--text-main);
  overflow-x: hidden;
}

/* MENU CON GRADIENTE ANIMADO */
@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--menu-height);
  background: linear-gradient(270deg, #f87171, #dc2626, #f87171);
  background-size: 600% 600%;
  animation: gradientMove 10s ease infinite;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 40px;
  box-shadow: var(--shadow-menu);
  z-index: 1000;
  border-bottom: 2px solid #fff5f5;
  transition: all 0.3s ease;
}
header:hover { transform: none; box-shadow: var(--shadow-menu); }
header .logo {
  font-weight: 700;
  font-size: 1.7rem;
  color: #fff;
  letter-spacing: 1px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.25);
}
header nav a {
  margin-left: 28px;
  text-decoration: none;
  color: #fff;
  font-weight: 500;
  position: relative;
  padding: 6px 0;
  transition: all 0.3s ease;
}
header nav a::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 50%;
  width: 0;
  height: 3px;
  background-color: #fff;
  border-radius: 2px;
  transition: all 0.3s ease;
  transform: translateX(-50%);
}
header nav a:hover { transform: translateY(-3px) scale(1.08); }
header nav a:hover::after { width: 100%; }

/* MAIN */
main {
  display: flex;
  justify-content: space-between;
  gap: 24px;
  padding: calc(var(--menu-height) + 40px) 40px 40px 40px;
  transition: all 0.3s ease;
}

/* PANELS */
.left-panel, .right-panel {
  background: var(--card-bg);
  border-radius: 20px;
  box-shadow: var(--shadow-soft);
  padding: 20px;
  min-height: 500px;
  flex: 1;
  max-width: 50%;
}

/* TITULOS */
h1 { font-size: 1.6rem; margin-bottom: 14px; color: #334155; display: flex; align-items: center; gap: 6px; }
h1::before { content: "üìä"; }
h3 { font-size: 1rem; color: #475569; margin-bottom: 10px; }

/* BUSCADOR */
.search-box { display: flex; gap: 10px; margin-bottom: 14px; }
.search-box input {
  flex: 1;
  padding: 8px 12px;
  border-radius: 12px;
  border: 2px solid #f87171;
  font-size: 13px;
}
.search-box input:focus {
  border-color: var(--primary-red);
  outline: none;
  box-shadow: 0 0 0 4px rgba(239,68,68,0.25);
}
.search-box button {
  display: flex;
  align-items: center;
  gap: 4px;
  background: linear-gradient(270deg, #f87171, #dc2626, #f87171);
  background-size: 600% 600%;
  animation: gradientMove 6s ease infinite;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

/* TABLAS COMPACTAS */
table { width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 10px; }
th {
  background: #fee2e2;
  color: var(--text-main);
  font-weight: 600;
  border-bottom: 1px solid #fca5a5;
  text-align: center;
  padding: 4px 6px;
}
td {
  border-bottom: 1px solid #fef2f2;
  text-align: center;
  color: #0f172a;
  padding: 2px 4px;
  position: relative;
}
td:first-child { text-align: left; font-weight: 500; }
tbody tr:nth-child(even) { background: #fff5f5; }
tbody tr:hover { background: #fee2e2; }

/* TOOLTIP CON MINI BARRA */
td[data-tooltip]:hover::after {
  content: '';
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 8px;
  background: linear-gradient(to right, #16a34a var(--bar-width,0%), #d1d5db var(--bar-width,0%));
  border-radius: 4px;
  white-space: nowrap;
  z-index: 10;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
td[data-tooltip]:hover::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 140%;
  left: 50%;
  transform: translateX(-50%) scale(1);
  background: #1e293b;
  color: white;
  font-size: 9px;
  padding: 2px 5px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 11;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
td[data-tooltip]:hover::after,
td[data-tooltip]:hover::before {
  opacity: 1;
  transform: translateX(-50%) scale(1.05);
}

/* DIVIDER */
.divider { border-top: 2px solid #fca5a5; margin: 16px 0; }

/* GRAFICO ANILLO */
.chart-container { position: relative; width: 160px; height: 160px; margin: 16px auto; }
svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.circle-bg { fill: none; stroke: #d1d5db; stroke-width: 12; }
.circle-progress {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
  stroke-dasharray: 565.48;
  stroke-dashoffset: 565.48;
  transition: stroke 0.25s ease;
}
.percentage {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.8rem;
  font-weight: 700;
  color: #111827;
}
.subtitle { text-align: center; color: #64748b; font-size: 0.8rem; margin-top: 4px; }

/* ESTADOS */
.c-bad { color: #b91c1c !important; font-weight: 600; }
.c-warn { color: #f97316 !important; font-weight: 600; }
.c-good { color: #16a34a !important; font-weight: 600; }
.cell-error { background: #fee2e2; color: #b91c1c; font-weight: 600; border-radius: 4px; }
.cell-ok { background: #dcfce7; color: #16a34a; font-weight: 600; border-radius: 4px; }

/* MENSAJE DE ESTADO */
.status-message {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  border: 1px solid #f87171;
  border-radius: 12px;
  padding: 12px 16px;
  box-shadow: 0 6px 12px rgba(239,68,68,0.25);
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85rem;
  color: #16a34a;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s ease;
  z-index: 9999;
}
.status-message.show { opacity: 1; transform: translateY(0); }
.status-message .check-icon { font-size: 1.2rem; color: #16a34a; }

/* MENSAJE DIN√ÅMICO CENTRAL (CELEBRACI√ìN) */
#celebration-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size: 2rem;
  font-weight: 700;
  color: #f43f5e;
  text-align: center;
  text-shadow: 0 2px 10px rgba(244, 63, 94, 0.3);
  z-index: 9997;
  opacity: 0;
  pointer-events: none;
  transition: all 0.6s ease;
  font-family: 'Inter', sans-serif;
  white-space: nowrap;
}
#celebration-message.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  color: #16a34a;
  text-shadow: 0 0 20px rgba(22, 163, 74, 0.5);
}

/* LOADER */
.loader {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #ef4444;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 16px auto;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

/* RESPONSIVE */
@media (max-width: 900px) {
  main { flex-direction: column; padding: calc(var(--menu-height) + 20px) 16px 16px 16px; }
  .left-panel, .right-panel { max-width: 100%; }
}

/* ESTILO CONFETI */
#confetti-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9996;
}
</style>
</head>

<body>
<header>
  <div class="logo">SBKTC360</div>
  <nav>
    <a href="#">Inicio</a>
    <a href="#">Evaluaciones</a>
    <a href="#">Reportes</a>
    <a href="#">Configuraci√≥n</a>
  </nav>
</header>

<main>
  <div class="left-panel">
    <h1>Consulta tus notas de calidad</h1>
    <div class="search-box">
      <input type="text" id="dniInput" placeholder="Buscar DNI (ej: 42882142)" />
      <button id="btnSearch">üîç Buscar</button>
    </div>
    <div id="resultContainer"><div class="info">üîç Ingresa un DNI para ver los resultados</div></div>
  </div>

  <div class="right-panel">
    <h3>‚ö†Ô∏è Seguimiento por semana</h3>
    <div id="errorContainer"><div class="info">Esperando datos...</div></div>
  </div>
</main>

<div id="statusMessage" class="status-message">
  <span class="check-icon">‚úÖ</span>
  <span>Notas de calidad cargadas</span>
</div>

<!-- CANVAS PARA CONFETI -->
<canvas id="confetti-canvas"></canvas>

<!-- MENSAJE DIN√ÅMICO CENTRAL -->
<div id="celebration-message">¬°Felicidades!</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRp7iRBUwVpHnmf7Q0mLyARIBl-inFlZbH43i3wU1whcjE0GlPi7Z51VcmXRsWrcYCmWMS1WTL-ySJt/pub?gid=2119161122&single=true&output=csv";

const COLUMNS = [
  { key: '1_COMUNICACI√ìN', label: 'Comunicaci√≥n' },
  { key: '2_INFORMACI√ìN', label: 'Informaci√≥n' },
  { key: '3_GESTION DE VENTA (PRE VENTA)', label: 'Gesti√≥n de Venta (Preventa)' },
  { key: '4_REGULATORIO', label: 'Regulatorio' },
  { key: 'NOTA', label: 'Nota General' }
];

const DETAIL_COLUMNS = [
  { key: '1.1 PROTOCOLO DE BIENVENIDA Y DESPEDIDA', label: 'Protocolo de bienvenida y despedida' },
  { key: '1.2 CAPACIDAD DE FLUIDEZ Y VOCALIZACI√ìN', label: 'Fluidez y vocalizaci√≥n' },
  { key: '1.3 PRESENTA SONRISA TELEFONICA', label: 'Sonrisa telef√≥nica' },
  { key: '1.4 NO UTILIZA TECNISISMOS', label: 'No usa tecnicismos' },
  { key: '1.5 NO UTILIZA MULETILLAS', label: 'No usa muletillas' },
  { key: '1.6 ESCUCHA ACTIVA', label: 'Escucha activa' },
  { key: '1.7 NO REALIZA TUTEO (PERSONALIZACION)', label: 'No tuteo (personalizaci√≥n)' },
  { key: '2.1 BRINDA CARACTERISTICAS CORRECTAS DEL PRODUCTO', label: 'Caracter√≠sticas correctas del producto' },
  { key: '2.2 BRINDA CARACTERISTICAS COMPLETAS DEL PRODUCTO', label: 'Caracter√≠sticas completas del producto' },
  { key: '2.3 PRESENTA BENEFICIOS DE MANERA CORRECTA', label: 'Beneficios correctos' },
  { key: '2.4 PRESENTA BENEFICIOS DE MANERA COMPLETA', label: 'Beneficios completos' },
  { key: '2.5 ACLARA DUDAS DEL CLIENTE', label: 'Aclara dudas del cliente' },
  { key: '3.1 SONDEA LA NECESIDAD DE CLIENTE', label: 'Sondea necesidad del cliente' },
  { key: '3.2 REBATE LA NEGATIVA DEL CLIENTE', label: 'Rebate la negativa' },
  { key: '3.3 REBATE DE ACUERDO A LA NEGATIVA DEL CLIENTE', label: 'Rebate seg√∫n negativa' },
  { key: '3.4 APLICA CIERRE DE VENTA', label: 'Cierre de venta' },
  { key: '3.5 OFRECE CORRECTAMENTE CUENTA DIGITAL', label: 'Ofrece cuenta digital' },
  { key: '3.6 TIPIFICACI√ìN', label: 'Tipificaci√≥n' },
  { key: '4.1 LPDP (FLAG 0 & 2)', label: 'LPDP (Flag 0 & 2)' }
];

let allData = [];
let confettiCanvas, confettiCtx;
let confettiPieces = [];
const confettiColors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];

// Inicializar canvas para confeti
function initConfetti() {
    confettiCanvas = document.getElementById('confetti-canvas');
    confettiCtx = confettiCanvas.getContext('2d');
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
}

function resizeCanvas() {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
}

// Clase para cada trozo de confeti
class ConfettiPiece {
    constructor() {
        this.x = Math.random() * confettiCanvas.width;
        this.y = -20;
        this.width = Math.random() * 10 + 5;
        this.height = Math.random() * 8 + 3;
        this.speed = Math.random() * 3 + 2;
        this.color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
        this.rotation = Math.random() * 360;
        this.rotationSpeed = Math.random() * 5 - 2.5;
    }

    update() {
        this.y += this.speed;
        this.rotation += this.rotationSpeed;
    }

    draw() {
        confettiCtx.save();
        confettiCtx.translate(this.x, this.y);
        confettiCtx.rotate(this.rotation * Math.PI / 180);
        confettiCtx.fillStyle = this.color;
        confettiCtx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
        confettiCtx.restore();
    }
}

// Lanzar confeti
function launchConfetti() {
    confettiPieces = [];
    const pieceCount = 150;
    for (let i = 0; i < pieceCount; i++) {
        confettiPieces.push(new ConfettiPiece());
    }
    animateConfetti();
}

// Animar confeti
function animateConfetti() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    let activePieces = 0;

    confettiPieces.forEach(piece => {
        piece.update();
        piece.draw();
        if (piece.y < confettiCanvas.height) {
            activePieces++;
        }
    });

    if (activePieces > 0) {
        requestAnimationFrame(animateConfetti);
    } else {
        confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    }
}

// Mostrar mensaje din√°mico de celebraci√≥n
function showCelebrationMessage(nota) {
    const messageEl = document.getElementById('celebration-message');
    let text = '';

    if (nota >= 95) {
        text = "¬°Excelente! ¬°Eres un referente en calidad!";
    } else if (nota >= 90) {
        text = "¬°Impresionante! ¬°Tu desempe√±o es excepcional!";
    } else if (nota >= 85) {
        text = "¬°Felicidades! ¬°Lograste una nota sobresaliente!";
    } else {
        return; // No mostrar si no alcanza 85%
    }

    messageEl.textContent = text;
    messageEl.classList.add('show');

    // Desvanecer despu√©s de 5 segundos
    setTimeout(() => {
        messageEl.classList.remove('show');
    }, 5000);
}

// UTILS
function parseToPercent(raw) {
  if (!raw) return null;
  let s = String(raw).trim().replace('%','').replace(',','.');
  if (!s) return null;
  let n = parseFloat(s);
  if (isNaN(n)) return null;
  let v = n;
  if (Math.abs(v) <= 1) v = v * 100;
  if (v < 0) v = 0;
  if (v > 100) v = 100;
  return v;
}
function getColorClass(value) {
  if (value <= 65) return 'c-bad';
  if (value >= 85) return 'c-good';
  return 'c-warn';
}
function showStatusMessage(msg = "Notas de calidad cargadas") {
  const status = document.getElementById('statusMessage');
  status.querySelector('span:nth-child(2)').textContent = msg;
  status.classList.add('show');
  setTimeout(()=> status.classList.remove('show'), 5000);
}

// CARGA CSV
function loadData() {
  return new Promise((resolve)=>{
    const container = document.getElementById('resultContainer');
    container.innerHTML = '<div class="loader"></div>';
    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: function(results) {
        allData = results.data;
        container.innerHTML = '<div class="info">üîç Ingresa un DNI para ver los resultados</div>';
        resolve();
      }
    });
  });
}

// CALCULO PROMEDIO
function calcAvg(values) {
  const nums = values.filter(v=>v!==null && !isNaN(v));
  if(!nums.length) return 0;
  return nums.reduce((a,b)=>a+b,0)/nums.length;
}

// DONUT ANIMATION
function animateDonut(targetPercent) {
  const circle = document.querySelector('.circle-progress');
  const text = document.getElementById('percentValue');
  const radius = 90;
  const circumference = 2 * Math.PI * radius;
  circle.style.strokeDasharray = circumference;
  let offset = circumference;
  let current = 0;
  function step() {
    current += (targetPercent - current) * 0.1;
    if(Math.abs(current - targetPercent) < 0.1) current = targetPercent;
    const offset = circumference - (current/100)*circumference;
    circle.style.strokeDashoffset = offset;
    let color = "#facc15";
    if(current <= 65) color="#f43f5e";
    else if(current>=85) color="#2AC793";
    circle.style.stroke = color;
    text.style.color = color;
    text.textContent = current.toFixed(1)+'%';
    if(current<targetPercent) requestAnimationFrame(step);
    else {
      // Animaci√≥n terminada ‚Üí Activar celebraci√≥n
      if (targetPercent >= 85) {
        launchConfetti();
        showCelebrationMessage(targetPercent);
      }
    }
  }
  requestAnimationFrame(step);
}

// BUSCAR POR DNI
async function searchByDNI() {
  const dni = document.getElementById('dniInput').value.trim();
  if(!dni) return alert("Ingresa un DNI");
  if(!allData.length) await loadData();
  const filtered = allData.filter(r=>r.DNI && r.DNI.toString().includes(dni));
  if(!filtered.length){
    document.getElementById('resultContainer').innerHTML = `<div class="error">No se encontr√≥ el DNI ${dni}</div>`;
    document.getElementById('errorContainer').innerHTML = "";
    return;
  }
  const nombre = filtered[0]?.AGENTE || "Sin nombre";
  const weeks = [...new Set(filtered.map(r=>r.SEMANA||'Sin semana'))].sort();

  // TABLA IZQUIERDA
  let table = `<h3>Resultados para: ${nombre}</h3>
    <table><thead><tr><th>Bloques</th>${weeks.map(w=>`<th>${w}</th>`).join('')}</tr></thead><tbody>`;
  COLUMNS.forEach(col=>{
    table+=`<tr><td>${col.label}</td>`;
    weeks.forEach(w=>{
      const vals = filtered.filter(r=>(r.SEMANA||'Sin semana')===w).map(r=>parseToPercent(r[col.key])).filter(x=>x!==null);
      const avgWeek = calcAvg(vals);
      const cls = getColorClass(avgWeek);
      table+=`<td class="${cls}" data-tooltip="${avgWeek.toFixed(1)}%" style="--bar-width:${avgWeek}%">`+avgWeek.toFixed(1)+'%</td>';
    });
    table+='</tr>';
  });
  table+='</tbody></table><div class="divider"></div>';
  const notaGlobal = calcAvg(filtered.map(r=>parseToPercent(r['NOTA'])));
  table+=`<div class="chart-container">
            <svg viewBox="0 0 200 200">
              <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
              <circle class="circle-progress" cx="100" cy="100" r="90"></circle>
            </svg>
            <div class="percentage" id="percentValue">0%</div>
          </div>
          <div class="subtitle">(%) Nota General | (Evaluaciones: ${filtered.length})</div>`;
  document.getElementById('resultContainer').innerHTML = table;
  animateDonut(notaGlobal);

  // TABLA DERECHA DETALLE
  let detail = `<table><thead><tr><th>Atributos</th>${weeks.map(w=>`<th>${w}</th>`).join('')}</tr></thead><tbody>`;
  DETAIL_COLUMNS.forEach(col=>{
    detail+=`<tr><td>${col.label}</td>`;
    weeks.forEach(w=>{
      const sums = filtered.filter(r=>(r.SEMANA||'Sin semana')===w)
        .map(r=>parseInt(String(r[col.key]||0).replace(/\D/g,''),10))
        .filter(v=>!isNaN(v));
      const sum = sums.reduce((a,b)=>a+b,0);
      detail+=`<td class="${sum>=1?'cell-error':'cell-ok'}" data-tooltip="${sum}" style="--bar-width:${sum*10}%">${sum>=1?'‚ùå':'‚úÖ'}</td>`;
    });
    detail+='</tr>';
  });
  detail+='</tbody></table>';
  document.getElementById('errorContainer').innerHTML = detail;
  showStatusMessage();
}

document.getElementById('btnSearch').addEventListener('click', searchByDNI);
document.getElementById('dniInput').addEventListener('keyup', e=>{
  if(e.key==='Enter') searchByDNI();
});

// Inicializar confeti y cargar datos
window.onload = () => {
    initConfetti();
    loadData();
};
</script>
</body>
</html>
