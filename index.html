<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SBK360 | Notas</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --primary-red: #ef4444;
  --primary-dark: #b91c1c;
  --bg-gradient: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);
  --card-bg: #ffffff;
  --text-main: #1e293b;
  --text-muted: #64748b;
  --shadow-soft: 0 4px 12px rgba(0,0,0,0.06);
  --shadow-menu: 0 8px 24px rgba(239,68,68,0.3);
  --menu-height: 70px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-gradient);
  color: var(--text-main);
  overflow-x: hidden;
}

@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: var(--menu-height);
  background: linear-gradient(270deg, #f87171, #dc2626, #f87171);
  background-size: 600% 600%;
  animation: gradientMove 10s ease infinite;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 40px;
  box-shadow: var(--shadow-menu);
  z-index: 1000;
  border-bottom: 2px solid #fff5f5;
  transition: all 0.3s ease;
}
header .logo { font-weight: 700; font-size: 1.7rem; color: #fff; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.25); }
header nav a {
  margin-left: 28px;
  text-decoration: none;
  color: #fff;
  font-weight: 500;
  position: relative;
  padding: 6px 0;
  transition: all 0.3s ease;
}
header nav a::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 50%;
  width: 0;
  height: 3px;
  background-color: #fff;
  border-radius: 2px;
  transition: all 0.3s ease;
  transform: translateX(-50%);
}
header nav a:hover { transform: translateY(-3px) scale(1.08); }
header nav a:hover::after { width: 100%; }

main {
  display: flex;
  justify-content: space-between;
  gap: 24px;
  padding: calc(var(--menu-height) + 40px) 40px 40px 40px;
  transition: all 0.3s ease;
}

.left-panel, .right-panel {
  background: var(--card-bg);
  border-radius: 20px;
  box-shadow: var(--shadow-soft);
  padding: 20px;
  min-height: 500px;
  flex: 1;
  max-width: 50%;
}

h1 { font-size: 1.6rem; margin-bottom: 14px; color: #334155; display: flex; align-items: center; gap: 6px; }
h1::before { content: "üìä"; }
h3 { font-size: 1rem; color: #475569; margin-bottom: 10px; }

.search-box { display: flex; gap: 10px; margin-bottom: 14px; }
.search-box input {
  flex: 1;
  padding: 8px 12px;
  border-radius: 12px;
  border: 2px solid #f87171;
  font-size: 13px;
}
.search-box input:focus {
  border-color: var(--primary-red);
  outline: none;
  box-shadow: 0 0 0 4px rgba(239,68,68,0.25);
}
.search-box button {
  display: flex;
  align-items: center;
  gap: 4px;
  background: linear-gradient(270deg, #f87171, #dc2626, #f87171);
  background-size: 600% 600%;
  animation: gradientMove 6s ease infinite;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}

table { width: 100%; border-collapse: collapse; margin-top: 6px; font-size: 10px; }
th {
  background: #fee2e2;
  color: var(--text-main);
  font-weight: 600;
  border-bottom: 1px solid #fca5a5;
  text-align: center;
  padding: 4px 6px;
}
td {
  border-bottom: 1px solid #fef2f2;
  text-align: center;
  color: #0f172a;
  padding: 2px 4px;
  position: relative;
}
td:first-child { text-align: left; font-weight: 500; }
tbody tr:nth-child(even) { background: #fff5f5; }
tbody tr:hover { background: #fee2e2; }

td[data-tooltip]:hover::after {
  content: '';
  position: absolute;
  bottom: 120%;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 8px;
  background: linear-gradient(to right, #16a34a var(--bar-width,0%), #d1d5db var(--bar-width,0%));
  border-radius: 4px;
  white-space: nowrap;
  z-index: 10;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
td[data-tooltip]:hover::before {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 140%;
  left: 50%;
  transform: translateX(-50%) scale(1);
  background: #1e293b;
  color: white;
  font-size: 9px;
  padding: 2px 5px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 11;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
td[data-tooltip]:hover::after,
td[data-tooltip]:hover::before {
  opacity: 1;
  transform: translateX(-50%) scale(1.05);
}

.divider { border-top: 2px solid #fca5a5; margin: 16px 0; }

.chart-container { position: relative; width: 160px; height: 160px; margin: 16px auto; }
svg { transform: rotate(-90deg); width: 100%; height: 100%; }
.circle-bg { fill: none; stroke: #d1d5db; stroke-width: 12; }
.circle-progress {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
  stroke-dasharray: 565.48;
  stroke-dashoffset: 565.48;
  transition: stroke 0.25s ease;
}
.percentage {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.8rem;
  font-weight: 700;
  color: #111827;
}
.subtitle { text-align: center; color: #64748b; font-size: 0.8rem; margin-top: 4px; }

.c-bad { color: #b91c1c !important; font-weight: 600; }
.c-warn { color: #f97316 !important; font-weight: 600; }
.c-good { color: #16a34a !important; font-weight: 600; }
.cell-error { background: #fee2e2; color: #b91c1c; font-weight: 600; border-radius: 4px; }
.cell-ok { background: #dcfce7; color: #16a34a; font-weight: 600; border-radius: 4px; }

.status-message {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  border: 1px solid #f87171;
  border-radius: 12px;
  padding: 12px 16px;
  box-shadow: 0 6px 12px rgba(239,68,68,0.25);
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85rem;
  color: #16a34a;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s ease;
  z-index: 9999;
}
.status-message.show { opacity: 1; transform: translateY(0); }
.status-message .check-icon { font-size: 1.2rem; color: #16a34a; }

#celebration-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size: 2rem;
  font-weight: 700;
  color: #f43f5e;
  text-align: center;
  text-shadow: 0 2px 10px rgba(244, 63, 94, 0.3);
  z-index: 9997;
  opacity: 0;
  pointer-events: none;
  transition: all 0.6s ease;
  font-family: 'Inter', sans-serif;
  white-space: nowrap;
}
#celebration-message.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  color: #16a34a;
  text-shadow: 0 0 20px rgba(22, 163, 74, 0.5);
}

.suggestion-box {
  margin-top: 16px;
  padding: 12px;
  background: #fef3c7;
  border-left: 4px solid #f59e0b;
  border-radius: 8px;
  font-size: 0.9rem;
  color: #78350f;
}

.trend-indicator {
  display: inline-block;
  font-size: 0.85rem;
  font-weight: 600;
  margin-left: 8px;
  padding: 2px 6px;
  border-radius: 12px;
}
.trend-up { color: #16a34a; background: #dcfce7; }
.trend-down { color: #b91c1c; background: #fee2e2; }
.trend-flat { color: #64748b; background: #f1f5f9; }

.loader {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #ef4444;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 16px auto;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

@media (max-width: 900px) {
  main { flex-direction: column; padding: calc(var(--menu-height) + 20px) 16px 16px 16px; }
  .left-panel, .right-panel { max-width: 100%; }
}

#confetti-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9996;
}
</style>
</head>

<body>
<header>
  <div class="logo">SBKTC360</div>
  <nav>
    <a href="#">Inicio</a>
    <a href="#">Evaluaciones</a>
    <a href="#">Reportes</a>
    <a href="#">Configuraci√≥n</a>
  </nav>
</header>

<main>
  <div class="left-panel">
    <h1>Consulta tus notas de calidad</h1>
    <div class="search-box">
      <input type="text" id="dniInput" placeholder="Buscar DNI (ej: 42882142)" />
      <button id="btnSearch">üîç Buscar</button>
    </div>
    <div id="resultContainer"><div class="info">üîç Ingresa un DNI para ver los resultados</div></div>
  </div>

  <div class="right-panel">
    <h3>‚ö†Ô∏è Seguimiento por semana</h3>
    <div id="errorContainer"><div class="info">Esperando datos...</div></div>
  </div>
</main>

<div id="statusMessage" class="status-message">
  <span class="check-icon">‚úÖ</span>
  <span>Notas de calidad cargadas</span>
</div>

<canvas id="confetti-canvas"></canvas>
<div id="celebration-message">¬°Felicidades!</div>

<script>
// üî• CONFIGURACI√ìN: reemplaza con tu URL de Web App de Apps Script
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/REEMPLAZA_CON_TU_WEB_APP_URL/exec";

// Definiciones de columnas (solo para etiquetas)
const COLUMNS = [
  { key: '1_COMUNICACI√ìN', label: 'Comunicaci√≥n' },
  { key: '2_INFORMACI√ìN', label: 'Informaci√≥n' },
  { key: '3_GESTION DE VENTA (PRE VENTA)', label: 'Gesti√≥n de Venta (Preventa)' },
  { key: '4_REGULATORIO', label: 'Regulatorio' },
  { key: 'NOTA', label: 'Nota General' }
];

const DETAIL_COLUMNS = [
  { key: '1.1 PROTOCOLO DE BIENVENIDA Y DESPEDIDA', label: 'Protocolo de bienvenida y despedida' },
  { key: '1.2 CAPACIDAD DE FLUIDEZ Y VOCALIZACI√ìN', label: 'Fluidez y vocalizaci√≥n' },
  { key: '1.3 PRESENTA SONRISA TELEFONICA', label: 'Sonrisa telef√≥nica' },
  { key: '1.4 NO UTILIZA TECNISISMOS', label: 'No usa tecnicismos' },
  { key: '1.5 NO UTILIZA MULETILLAS', label: 'No usa muletillas' },
  { key: '1.6 ESCUCHA ACTIVA', label: 'Escucha activa' },
  { key: '1.7 NO REALIZA TUTEO (PERSONALIZACION)', label: 'No tuteo (personalizaci√≥n)' },
  { key: '2.1 BRINDA CARACTERISTICAS CORRECTAS DEL PRODUCTO', label: 'Caracter√≠sticas correctas del producto' },
  { key: '2.2 BRINDA CARACTERISTICAS COMPLETAS DEL PRODUCTO', label: 'Caracter√≠sticas completas del producto' },
  { key: '2.3 PRESENTA BENEFICIOS DE MANERA CORRECTA', label: 'Beneficios correctos' },
  { key: '2.4 PRESENTA BENEFICIOS DE MANERA COMPLETA', label: 'Beneficios completos' },
  { key: '2.5 ACLARA DUDAS DEL CLIENTE', label: 'Aclara dudas del cliente' },
  { key: '3.1 SONDEA LA NECESIDAD DE CLIENTE', label: 'Sondea necesidad del cliente' },
  { key: '3.2 REBATE LA NEGATIVA DEL CLIENTE', label: 'Rebate la negativa' },
  { key: '3.3 REBATE DE ACUERDO A LA NEGATIVA DEL CLIENTE', label: 'Rebate seg√∫n negativa' },
  { key: '3.4 APLICA CIERRE DE VENTA', label: 'Cierre de venta' },
  { key: '3.5 OFRECE CORRECTAMENTE CUENTA DIGITAL', label: 'Ofrece cuenta digital' },
  { key: '3.6 TIPIFICACI√ìN', label: 'Tipificaci√≥n' },
  { key: '4.1 LPDP (FLAG 0 & 2)', label: 'LPDP (Flag 0 & 2)' }
];

// Mapeo de nombre a √≠ndice para el detalle
const headersToIndex = {
  'DNI': 0, 'AGENTE': 1, 'SEMANA': 2,
  '1_COMUNICACI√ìN': 3, '2_INFORMACI√ìN': 4, '3_GESTION DE VENTA (PRE VENTA)': 5,
  '4_REGULATORIO': 6, 'NOTA': 7, 'FECHA': 8,
  '1.1 PROTOCOLO DE BIENVENIDA Y DESPEDIDA': 9,
  '1.2 CAPACIDAD DE FLUIDEZ Y VOCALIZACI√ìN': 10,
  '1.3 PRESENTA SONRISA TELEFONICA': 11,
  '1.4 NO UTILIZA TECNISISMOS': 12,
  '1.5 NO UTILIZA MULETILLAS': 13,
  '1.6 ESCUCHA ACTIVA': 14,
  '1.7 NO REALIZA TUTEO (PERSONALIZACION)': 15,
  '2.1 BRINDA CARACTERISTICAS CORRECTAS DEL PRODUCTO': 16,
  '2.2 BRINDA CARACTERISTICAS COMPLETAS DEL PRODUCTO': 17,
  '2.3 PRESENTA BENEFICIOS DE MANERA CORRECTA': 18,
  '2.4 PRESENTA BENEFICIOS DE MANERA COMPLETA': 19,
  '2.5 ACLARA DUDAS DEL CLIENTE': 20,
  '3.1 SONDEA LA NECESIDAD DE CLIENTE': 21,
  '3.2 REBATE LA NEGATIVA DEL CLIENTE': 22,
  '3.3 REBATE DE ACUERDO A LA NEGATIVA DEL CLIENTE': 23,
  '3.4 APLICA CIERRE DE VENTA': 24,
  '3.5 OFRECE CORRECTAMENTE CUENTA DIGITAL': 25,
  '3.6 TIPIFICACI√ìN': 26,
  '4.1 LPDP (FLAG 0 & 2)': 27
};

let confettiCanvas, confettiCtx;
const confettiColors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722'];

class ConfettiPiece {
  constructor(w, h) {
    this.x = Math.random() * w;
    this.y = -20;
    this.width = Math.random() * 10 + 5;
    this.height = Math.random() * 8 + 3;
    this.speed = Math.random() * 3 + 2;
    this.color = confettiColors[Math.floor(Math.random() * confettiColors.length)];
    this.rotation = Math.random() * 360;
    this.rotationSpeed = Math.random() * 5 - 2.5;
  }

  update() {
    this.y += this.speed;
    this.rotation += this.rotationSpeed;
  }

  draw(ctx) {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation * Math.PI / 180);
    ctx.fillStyle = this.color;
    ctx.fillRect(-this.width / 2, -this.height / 2, this.width, this.height);
    ctx.restore();
  }
}

function initConfetti() {
  confettiCanvas = document.getElementById('confetti-canvas');
  confettiCtx = confettiCanvas.getContext('2d');
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
}

function resizeCanvas() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
}

function launchConfetti() {
  const pieces = [];
  const count = 150;
  for (let i = 0; i < count; i++) {
    pieces.push(new ConfettiPiece(confettiCanvas.width, confettiCanvas.height));
  }

  function animate() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    let active = 0;
    pieces.forEach(p => {
      p.update();
      p.draw(confettiCtx);
      if (p.y < confettiCanvas.height) active++;
    });
    if (active > 0) requestAnimationFrame(animate);
  }
  animate();
}

function showCelebrationMessage(nota) {
  const msg = document.getElementById('celebration-message');
  let text = '';
  if (nota >= 95) text = "¬°Excelente! ¬°Eres un referente en calidad!";
  else if (nota >= 90) text = "¬°Impresionante! ¬°Tu desempe√±o es excepcional!";
  else if (nota >= 85) text = "¬°Felicidades! ¬°Lograste una nota sobresaliente!";
  else return;

  msg.textContent = text;
  msg.classList.add('show');
  setTimeout(() => msg.classList.remove('show'), 5000);
}

function getColorClass(value) {
  if (value <= 65) return 'c-bad';
  if (value >= 85) return 'c-good';
  return 'c-warn';
}

function showStatusMessage(text = "Notas de calidad cargadas") {
  const el = document.getElementById('statusMessage');
  el.querySelector('span:nth-child(2)').textContent = text;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 5000);
}

function animateDonut(targetPercent) {
  const circle = document.querySelector('.circle-progress');
  const textEl = document.getElementById('percentValue');
  const radius = 90;
  const circumference = 2 * Math.PI * radius;
  circle.style.strokeDasharray = circumference;
  let current = 0;

  function step() {
    current += (targetPercent - current) * 0.1;
    if (Math.abs(current - targetPercent) < 0.1) current = targetPercent;
    const offset = circumference - (current / 100) * circumference;
    circle.style.strokeDashoffset = offset;
    
    let color = "#facc15";
    if (current <= 65) color = "#f43f5e";
    else if (current >= 85) color = "#2AC793";
    
    circle.style.stroke = color;
    textEl.style.color = color;
    textEl.textContent = current.toFixed(1) + '%';

    if (current < targetPercent) {
      requestAnimationFrame(step);
    } else {
      if (targetPercent >= 85) {
        launchConfetti();
        showCelebrationMessage(targetPercent);
      }
      circle.style.boxShadow = targetPercent >= 90 ? '0 0 20px rgba(22, 163, 74, 0.6)' : 'none';
    }
  }
  requestAnimationFrame(step);
}

// üî• NUEVA FUNCI√ìN PRINCIPAL: usa la API
async function searchByDNI() {
  const dni = document.getElementById('dniInput').value.trim();
  if (!dni) return alert("Ingresa un DNI");

  const left = document.getElementById('resultContainer');
  const right = document.getElementById('errorContainer');
  left.innerHTML = '<div class="loader"></div>';
  right.innerHTML = '<div class="loader"></div>';

  try {
    const res = await fetch(`${APPS_SCRIPT_URL}?dni=${encodeURIComponent(dni)}`);
    const data = await res.json();

    if (data.error) throw new Error(data.error);
    if (data.total === 0) throw new Error(`No se encontraron registros para el DNI ${dni}`);

    const nombre = data.registros[0][1] || "Sin nombre"; // AGENTE = √≠ndice 1
    const promedios = data.promedios;
    const notaGlobal = promedios?.NOTA ?? 0;

    // Panel izquierdo: promedios generales
    let table = `<h3>Resultados para: ${nombre}`;
    if (notaGlobal >= 85) {
      table += `<span style="display: inline-block; background: #fbbf24; color: #1e293b; font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; margin-left: 8px; font-weight: 600;">üåü Excelente</span>`;
    }
    table += `</h3>`;

    table += `<table><thead><tr><th>Bloques</th><th>Promedio</th></tr></thead><tbody>`;
    COLUMNS.forEach(col => {
      const valor = promedios[col.key] || 0;
      const cls = getColorClass(valor);
      table += `<tr><td>${col.label}</td><td class="${cls}" data-tooltip="${valor.toFixed(1)}%" style="--bar-width:${valor}%">${valor.toFixed(1)}%</td></tr>`;
    });
    table += `</tbody></table>`;

    table += `<div class="divider"></div>
              <div class="chart-container">
                <svg viewBox="0 0 200 200">
                  <circle class="circle-bg" cx="100" cy="100" r="90"></circle>
                  <circle class="circle-progress" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="percentage" id="percentValue">0%</div>
              </div>
              <div class="subtitle">(%) Nota General | (Evaluaciones: ${data.total})</div>`;

    if (notaGlobal < 85) {
      const worst = COLUMNS.slice(0, -1).reduce((w, col) => {
        const avg = promedios[col.key] || 100;
        return avg < w.avg ? { key: col.label, avg } : w;
      }, { key: '', avg: 100 });

      table += `<div class="suggestion-box">üí° <strong>Sugerencia:</strong> Tu bloque a mejorar es <strong>${worst.key}</strong> (${worst.avg.toFixed(1)}%). Recuerda: mejorar aqu√≠ puede elevar tu nota general en hasta 15%.</div>`;
    }

    left.innerHTML = table;
    animateDonut(notaGlobal);

    // Panel derecho: √∫ltimo registro detallado
    const last = data.registros[data.registros.length - 1];
    let detail = `<table><thead><tr><th>Atributos</th><th>Resultado</th></tr></thead><tbody>`;
    DETAIL_COLUMNS.forEach(col => {
      const idx = headersToIndex[col.key];
      const val = last?.[idx] ?? 0;
      const clean = typeof val === 'string' ? parseInt(val.replace(/\D/g, ''), 10) : Number(val);
      const isValid = clean === 0;
      detail += `<tr><td>${col.label}</td><td class="${isValid ? 'cell-ok' : 'cell-error'}" data-tooltip="${clean}">${isValid ? '‚úÖ' : '‚ùå'}</td></tr>`;
    });
    detail += `</tbody></table>`;
    right.innerHTML = detail;

    showStatusMessage();
  } catch (err) {
    console.error(err);
    const msg = err.message || 'Error desconocido';
    document.getElementById('resultContainer').innerHTML = `<div class="error">${msg}</div>`;
    document.getElementById('errorContainer').innerHTML = "";
  }
}

document.getElementById('btnSearch').addEventListener('click', searchByDNI);
document.getElementById('dniInput').addEventListener('keyup', e => {
  if (e.key === 'Enter') searchByDNI();
});

window.onload = () => {
  initConfetti();
};
</script>
</body>
</html>
